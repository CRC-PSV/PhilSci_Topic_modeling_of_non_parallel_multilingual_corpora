---
title: "Topology preservation test"
author: "Francis Lareau"
date: "21/03/2021"
knit: (function(inputFile, encoding) {
  output_dir <- "/Scripts_html";
  if(!dir.exists(output_dir)) {dir.create(output_dir)};
  rmarkdown::render(inputFile, encoding = encoding, output_dir = output_dir) })
output:
  html_document:
    number_sections: false
    toc: yes
    toc_float: true
    theme: united
    highlight: zenburn
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = FALSE)
```
   
```{r 1 Librairies}

if(!('dplyr' %in% rownames(installed.packages()))){install.packages('dplyr')}
library(dplyr)

if(!('xlsx' %in% rownames(installed.packages()))){install.packages('xlsx')}
library(xlsx)

if(!('readr' %in% rownames(installed.packages()))){install.packages('readr')}
library(readr)

if(!('FactoMineR' %in% rownames(installed.packages()))){install.packages('FactoMineR')}

if(!('vegan' %in% rownames(installed.packages()))){install.packages('vegan')}

if(!('RSpectra' %in% rownames(installed.packages()))){install.packages('RSpectra')}

if(!('parallelDist'%in% rownames(installed.packages()))){install.packages('parallelDist')}

setwd("D:\\NLP\\projetjstor\\Consolidation\\Translation")

```

```{r 2 Topology preservation test for FR}

#RDS encoded DTM import
DTM_trad_fr <- readRDS(paste0(getwd(),"\\0. Data\\DTM_philosophy_of_science_translation_fr.rds"))
DTM_orig_fr <- readRDS(paste0(getwd(),"\\0. Data\\DTM_philosophy_of_science_original_fr.rds"))

#Feature reduction to 100 by truncated svd
DTM_trad_fr_svd <- RSpectra::svds(DTM_trad_fr, 100)
DTM_trad_fr_svd <- DTM_trad_fr_svd$u %*% solve(diag((DTM_trad_fr_svd$d)))
DTM_orig_fr_svd <- RSpectra::svds(DTM_orig_fr, 100)
DTM_orig_fr_svd <- DTM_orig_fr_svd$u %*% solve(diag((DTM_orig_fr_svd$d)))

#DDM (distance) by l2
DDM_trad_fr <- parallelDist::parDist(DTM_trad_fr_svd, method = "euclidean", threads = 16)
DDM_orig_fr <- parallelDist::parDist(DTM_orig_fr_svd, method = "euclidean", threads = 16)

#Mantel
Mantel_fr <- vegan::mantel(DDM_trad_fr,DDM_orig_fr, method = 'pearson') 
#Procrustes
Procrustes_fr <- vegan::protest(as.matrix(DDM_trad_fr),as.matrix(DDM_orig_fr)) 
#RV
RV_fr <- FactoMineR::coeffRV(as.matrix(DDM_trad_fr),as.matrix(DDM_orig_fr))

```

```{r 3 Topology preservation test for DE}

#RDS encoded DTM import
DTM_trad_de <- readRDS(paste0(getwd(),"\\0. Data\\DTM_philosophy_of_science_translation_de.rds"))
DTM_orig_de <- readRDS(paste0(getwd(),"\\0. Data\\DTM_philosophy_of_science_original_de.rds"))

#Feature reduction to 100 by truncated svd
DTM_trad_de_svd <- RSpectra::svds(DTM_trad_de, 100)
DTM_trad_de_svd <- DTM_trad_de_svd$u %*% solve(diag((DTM_trad_de_svd$d)))
DTM_orig_de_svd <- RSpectra::svds(DTM_orig_de, 100)
DTM_orig_de_svd <- DTM_orig_de_svd$u %*% solve(diag((DTM_orig_de_svd$d)))

#DDM (distance) by l2
DDM_trad_de <- parallelDist::parDist(DTM_trad_de_svd, method = "euclidean", threads = 16)
DDM_orig_de <- parallelDist::parDist(DTM_orig_de_svd, method = "euclidean", threads = 16)

#Mantel
Mantel_de <- vegan::mantel(DDM_trad_de,DDM_orig_de, method = 'pearson') 
#Procrustes
Procrustes_de <- vegan::protest(as.matrix(DDM_trad_de),as.matrix(DDM_orig_de)) 
#RV
RV_de <- FactoMineR::coeffRV(as.matrix(DDM_trad_de),as.matrix(DDM_orig_de))

```

```{r 4 Topology preservation test for NL}

#RDS encoded DTM import
DTM_trad_nl <- readRDS(paste0(getwd(),"\\0. Data\\DTM_philosophy_of_science_translation_nl.rds"))
DTM_orig_nl <- readRDS(paste0(getwd(),"\\0. Data\\DTM_philosophy_of_science_original_nl.rds"))

#Feature reduction to 100 by truncated svd
DTM_trad_nl_svd <- RSpectra::svds(DTM_trad_nl, 100)
DTM_trad_nl_svd <- DTM_trad_nl_svd$u %*% solve(diag((DTM_trad_nl_svd$d)))
DTM_orig_nl_svd <- RSpectra::svds(DTM_orig_nl, 100)
DTM_orig_nl_svd <- DTM_orig_nl_svd$u %*% solve(diag((DTM_orig_nl_svd$d)))

#DDM (distance) by l2
DDM_trad_nl <- parallelDist::parDist(DTM_trad_nl_svd, method = "euclidean", threads = 16)
DDM_orig_nl <- parallelDist::parDist(DTM_orig_nl_svd, method = "euclidean", threads = 16)

#Mantel
Mantel_nl <- vegan::mantel(DDM_trad_nl,DDM_orig_nl, method = 'pearson') 
#Procrustes
Procrustes_nl <- vegan::protest(as.matrix(DDM_trad_nl),as.matrix(DDM_orig_nl)) 
#RV
RV_nl <- FactoMineR::coeffRV(as.matrix(DDM_trad_nl),as.matrix(DDM_orig_nl))

```

```{r 5 Results export}

DF_result <- data.frame(c(nrow(DTM_trad_nl),
                          sum(Matrix::colSums(DTM_orig_nl)!=0),
                          sum(Matrix::colSums(DTM_trad_nl)!=0),
                          Mantel_nl$statistic,
                          Procrustes_nl$scale,
                          RV_nl$rv),
                        c(nrow(DTM_trad_de),
                          sum(Matrix::colSums(DTM_orig_de)!=0),
                          sum(Matrix::colSums(DTM_trad_de)!=0),
                          Mantel_de$statistic,
                          Procrustes_de$scale,
                          RV_de$rv),
                        c(nrow(DTM_trad_fr),
                          sum(Matrix::colSums(DTM_orig_fr)!=0),
                          sum(Matrix::colSums(DTM_trad_fr)!=0),
                          Mantel_fr$statistic,
                          Procrustes_fr$scale,
                          RV_fr$rv),
                        row.names = c('Number of articles N(l)',
                                      'Number of termes in the original lexicon M(l)',
                                      'Number of termes in the translated lexicon M*(l)',
                                      'Mantel r',
                                      'Procrustes correlation',
                                      'RV coefficient'))

colnames(DF_result) <- c('Dutch', 'German','French')

write.xlsx(DF_result, file = paste0(getwd(),"\\3. Topology preservation test\\Results_of_topology_preservation_test.xlsx"), sheetName="Results", row.names=T)

```

